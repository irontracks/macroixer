<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacroMixer - Dr. Carlos Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a; /* Slate 900 - Darker base */
            color: #e2e8f0;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7); /* Slate 800 */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.4);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .progress-bar {
            transition: width 1s ease-in-out, height 1s ease-in-out;
        }
        
        .preset-btn {
            transition: all 0.3s ease;
        }
        .preset-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pb-10">

    <!-- Navbar -->
    <nav class="w-full bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-dna text-cyan-500 text-xl"></i>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">MacroMixer <span class="text-xs text-gray-500 font-normal ml-1">v2.1</span></h1>
            </div>
            <div id="auth-container" class="text-xs">
                 <button id="btn-login" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1 rounded border border-slate-600 transition-colors flex items-center gap-2">
                    <i class="fa-brands fa-google"></i> Entrar
                </button>
                <div id="user-status" class="hidden text-gray-400 flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full" id="connection-dot"></div>
                    <span id="username-display">Online</span>
                    <button id="btn-logout" class="ml-2 text-slate-500 hover:text-white"><i class="fa-solid fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="w-full max-w-md px-4 mt-6 space-y-6">

        <!-- Goals / Presets Section (Collapsible) -->
        <section id="goals-section" class="glass-panel rounded-xl p-4 shadow-lg hidden border-l-4 border-cyan-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-microchip mr-2"></i>Calibragem Dr. Carlos</h2>
                <button id="close-goals-btn" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>

            <!-- Dr Carlos Presets -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="applyPreset('A')" class="preset-btn bg-gradient-to-br from-red-900 to-red-700 hover:from-red-800 hover:to-red-600 border border-red-500/30 rounded-lg p-3 text-left group">
                    <div class="text-xs text-red-300 uppercase font-bold tracking-widest mb-1">Pré-Set A</div>
                    <div class="text-white font-bold text-sm"><i class="fa-solid fa-fire mr-1"></i> MASSACRE</div>
                    <div class="text-[10px] text-red-200 mt-1">Perna/Costas (High Carb)</div>
                </button>
                <button onclick="applyPreset('B')" class="preset-btn bg-gradient-to-br from-blue-900 to-blue-700 hover:from-blue-800 hover:to-blue-600 border border-blue-500/30 rounded-lg p-3 text-left group">
                    <div class="text-xs text-blue-300 uppercase font-bold tracking-widest mb-1">Pré-Set B</div>
                    <div class="text-white font-bold text-sm"><i class="fa-solid fa-snowflake mr-1"></i> VÁCUO</div>
                    <div class="text-[10px] text-blue-200 mt-1">Ombro/Braço (Low Carb)</div>
                </button>
            </div>

            <form id="goals-form" class="space-y-4">
                <!-- User Profile -->
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Peso Corporal (kg)</label>
                    <input type="number" id="user-weight" step="0.1" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-cyan-500 outline-none font-mono" placeholder="Ex: 93.0">
                    <p class="text-[10px] text-gray-500 mt-1">Base para cálculo de 2.5g a 3.0g de proteína.</p>
                </div>

                <!-- Custom Whey Config -->
                <div class="border-t border-slate-700/50 pt-3 mt-2 bg-slate-800/30 p-3 rounded-lg">
                    <label class="text-xs text-cyan-400 uppercase font-bold mb-2 block"><i class="fa-solid fa-flask mr-1"></i> Configuração do Whey</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-gray-400">Tamanho da Dose (g)</label>
                            <input type="number" id="whey-dose" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs" placeholder="Ex: 30">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400">Proteína na Dose (g)</label>
                            <input type="number" id="whey-prot" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs font-bold text-green-500" placeholder="Ex: 24">
                        </div>
                    </div>
                </div>

                <!-- Macros -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400">Calorias (kcal)</label>
                        <input type="number" id="goal-cals" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Proteína (g)</label>
                        <input type="number" id="goal-prot" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-green-500 outline-none font-bold">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Carboidrato (g)</label>
                        <input type="number" id="goal-carb" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Gordura (g)</label>
                        <input type="number" id="goal-fat" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-yellow-500 outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-3 rounded transition-all uppercase tracking-wider text-sm shadow-lg shadow-cyan-900/50">Salvar Calibragem</button>
            </form>
        </section>

        <!-- Dashboard / Equalizer -->
        <section class="glass-panel rounded-xl p-5 shadow-xl relative overflow-hidden">
             <!-- Background Grid Effect -->
             <div class="absolute inset-0 opacity-5 pointer-events-none" style="background-image: radial-gradient(#64748b 1px, transparent 1px); background-size: 20px 20px;"></div>

             <button id="edit-goals-btn" class="absolute top-3 right-3 text-slate-500 hover:text-cyan-400 text-xs uppercase font-bold tracking-wider z-10">
                <i class="fa-solid fa-gear mr-1"></i> Setup
            </button>
            
            <div class="flex items-center gap-2 mb-4">
                <div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div>
                <h2 class="text-cyan-500 text-xs uppercase font-bold tracking-widest">Painel de Controle</h2>
            </div>

            <!-- Calories Main -->
            <div class="mb-6 text-center relative z-10">
                <div class="text-4xl font-black text-white mb-1 tracking-tighter"><span id="display-cals">0</span> <span class="text-lg text-slate-500 font-medium">/ <span id="target-cals">0</span></span></div>
                <div class="w-full bg-slate-900 rounded-full h-4 overflow-hidden border border-slate-800">
                    <div id="bar-cals" class="bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 h-4 rounded-full progress-bar shadow-[0_0_15px_rgba(236,72,153,0.5)]" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs mt-2 text-slate-400 font-mono">
                    <span>CONSUMIDO</span>
                    <span id="saldo-cals">BUFFER: 0</span>
                </div>
            </div>

            <!-- Macros Grid -->
            <div class="grid grid-cols-3 gap-4 text-center relative z-10">
                <!-- Protein -->
                <div class="bg-slate-800/50 rounded-lg p-2 border border-green-900/30">
                    <div class="text-[10px] text-green-400 uppercase font-bold mb-2">Proteína</div>
                    <div class="w-full bg-slate-900 rounded-full h-20 relative mx-auto w-3 overflow-hidden flex flex-col justify-end group border border-slate-800">
                        <div id="bar-prot" class="bg-green-500 w-full progress-bar shadow-[0_0_10px_rgba(34,197,94,0.4)]" style="height: 0%"></div>
                    </div>
                    <div class="text-sm font-bold mt-2 text-white"><span id="display-prot">0</span>g</div>
                    <div class="text-[10px] text-slate-500">/<span id="target-prot">0</span></div>
                </div>
                <!-- Carbs -->
                <div class="bg-slate-800/50 rounded-lg p-2 border border-blue-900/30">
                    <div class="text-[10px] text-blue-400 uppercase font-bold mb-2">Carbo</div>
                    <div class="w-full bg-slate-900 rounded-full h-20 relative mx-auto w-3 overflow-hidden flex flex-col justify-end group border border-slate-800">
                        <div id="bar-carb" class="bg-blue-500 w-full progress-bar shadow-[0_0_10px_rgba(59,130,246,0.4)]" style="height: 0%"></div>
                    </div>
                    <div class="text-sm font-bold mt-2 text-white"><span id="display-carb">0</span>g</div>
                    <div class="text-[10px] text-slate-500">/<span id="target-carb">0</span></div>
                </div>
                <!-- Fat -->
                <div class="bg-slate-800/50 rounded-lg p-2 border border-yellow-900/30">
                    <div class="text-[10px] text-yellow-400 uppercase font-bold mb-2">Gordura</div>
                    <div class="w-full bg-slate-900 rounded-full h-20 relative mx-auto w-3 overflow-hidden flex flex-col justify-end group border border-slate-800">
                        <div id="bar-fat" class="bg-yellow-500 w-full progress-bar shadow-[0_0_10px_rgba(234,179,8,0.4)]" style="height: 0%"></div>
                    </div>
                    <div class="text-sm font-bold mt-2 text-white"><span id="display-fat">0</span>g</div>
                    <div class="text-[10px] text-slate-500">/<span id="target-fat">0</span></div>
                </div>
            </div>
        </section>

        <!-- Suggestion Box (Dynamic) -->
        <div id="suggestion-box" class="hidden bg-slate-800 border-l-4 border-cyan-500 p-4 rounded text-sm text-gray-300 shadow-lg">
            <div class="flex items-start gap-3">
                <i class="fa-solid fa-user-doctor text-cyan-400 text-lg mt-1"></i> 
                <div>
                    <span class="block text-xs text-cyan-500 font-bold uppercase mb-1">Dr. Carlos Bot</span>
                    <span id="suggestion-text">Analisando dados...</span>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <section class="glass-panel rounded-xl p-4 shadow-lg">
            <h2 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-3">Input de Refeição</h2>
            <div class="relative">
                <textarea id="meal-input" rows="4" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all resize-none font-mono text-sm" placeholder="Digite aqui... Ex:&#10;5 colheres de arroz&#10;2 bifes medios&#10;3 ovos&#10;Whey 40g"></textarea>
                <div class="absolute bottom-3 right-3">
                    <button id="btn-calculate" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white p-3 rounded-full shadow-lg transform hover:scale-105 transition-all w-12 h-12 flex items-center justify-center">
                        <i class="fa-solid fa-calculator"></i>
                    </button>
                </div>
            </div>
            <div class="flex flex-col gap-1 mt-2 ml-1">
                <p class="text-[10px] text-gray-500"><i class="fa-solid fa-circle-info mr-1 text-cyan-500"></i> Aceita gramas (preciso) ou colheres/conchas (aproximado).</p>
                <p class="text-[10px] text-gray-600 italic">Dica: Folhas < 300g? Nem registre (Fibra Fantasma).</p>
            </div>
        </section>

        <!-- Daily Log -->
        <section class="glass-panel rounded-xl p-4 shadow-lg pb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-gray-400 text-xs uppercase font-bold tracking-widest">Histórico de Hoje</h2>
                <button id="reset-day-btn" class="text-xs text-red-400 hover:text-red-300"><i class="fa-solid fa-trash mr-1"></i>Zerar</button>
            </div>
            
            <div id="logs-container" class="space-y-3">
                <div class="text-center text-gray-600 py-4 italic text-sm">Nenhuma refeição registrada hoje.</div>
            </div>
        </section>

    </main>

    <!-- Modal for Meal Details -->
    <div id="modal-result" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl w-full max-w-sm border border-slate-700 shadow-2xl overflow-hidden transform transition-all">
            <div class="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-white"><i class="fa-solid fa-check-circle text-cyan-500 mr-2"></i>Conferência</h3>
                <button id="close-modal" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <!-- Warning Banner for Approximate Measures -->
            <div id="accuracy-warning" class="hidden bg-yellow-900/40 border-l-4 border-yellow-500 p-3 mx-4 mt-4">
                <div class="flex gap-2 text-yellow-200 text-xs">
                    <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
                    <div>
                        <span class="font-bold">Cálculo Aproximado!</span>
                        <p class="opacity-80">Você usou colheres/peças. O erro pode ser de 20-30%. Use balança quando possível.</p>
                    </div>
                </div>
            </div>

            <div class="p-4 max-h-[50vh] overflow-y-auto" id="modal-content">
                <!-- Dynamic Content -->
            </div>
            <div class="p-4 bg-slate-900 border-t border-slate-700">
                <button id="confirm-meal" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-cyan-900/50">
                    Lançar na Dieta
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATABASE DE ALIMENTOS (Padronizado Dr. Carlos) ---
        // Macros por 100g.
        const foodDatabase = {
            "arroz": { c: 28, p: 2.5, f: 0.2, kcal: 130, unit: "Arroz Branco (Cozido)", approx: { colher: 25, escumadeira: 80, xicara: 150 } },
            "arroz integral": { c: 26, p: 2.6, f: 1, kcal: 124, unit: "Arroz Integral (Cozido)", approx: { colher: 25, escumadeira: 80 } },
            "feijao": { c: 14, p: 5, f: 0.5, kcal: 76, unit: "Feijão Carioca (Cozido)", approx: { colher: 20, concha: 140 } },
            "feijão": { c: 14, p: 5, f: 0.5, kcal: 76, unit: "Feijão Carioca (Cozido)", approx: { colher: 20, concha: 140 } },
            "frango": { c: 0, p: 31, f: 3.6, kcal: 165, unit: "Peito de Frango (Grelhado)", approx: { bife: 120, file: 120, pedaco: 100, colher: 30 } },
            "carne": { c: 0, p: 26, f: 8, kcal: 180, unit: "Patinho Moído (Pronto)", approx: { colher: 30, bife: 100, pedaco: 100 } },
            "patinho": { c: 0, p: 26, f: 8, kcal: 180, unit: "Patinho Moído (Pronto)", approx: { colher: 30 } },
            "bife": { c: 0, p: 26, f: 8, kcal: 200, unit: "Bife Bovino (Grelhado)", approx: { unidade: 120, medio: 120, grande: 180, pequeno: 80 } },
            "ovo": { c: 0.6, p: 6, f: 5, kcal: 70, unit: "Ovo Inteiro", approx: { unidade: 50 } },
            "claras": { c: 0, p: 13, f: 0, kcal: 54, unit: "Clara de Ovo (Pasteurizada)", approx: { xicara: 240, colher: 15 } },
            "aveia": { c: 57, p: 14, f: 6, kcal: 389, unit: "Aveia em Flocos", approx: { colher: 15, xicara: 80 } },
            "banana": { c: 23, p: 1, f: 0.3, kcal: 89, unit: "Banana Prata", approx: { unidade: 80, media: 80 } },
            "batata": { c: 17, p: 2, f: 0, kcal: 77, unit: "Batata Inglesa (Cozida)", approx: { colher: 30, unidade: 150 } },
            "batata doce": { c: 20, p: 1.6, f: 0.5, kcal: 86, unit: "Batata Doce (Cozida)", approx: { colher: 30, unidade: 150, rodelas: 40 } },
            "whey": { c: 3, p: 24, f: 1, kcal: 120, unit: "Whey Protein (Dose Padrão)", approx: { scoop: 30, dose: 30, colher: 15 } },
            "monster": { c: 2, p: 0, f: 0, kcal: 10, unit: "Monster Zero (Lata)", approx: { lata: 1, unidade: 1 } },
            "monster zero": { c: 2, p: 0, f: 0, kcal: 10, unit: "Monster Zero (Lata)", approx: { lata: 1, unidade: 1 } },
            "pao": { c: 49, p: 9, f: 3, kcal: 265, unit: "Pão Francês", approx: { unidade: 50 } },
            "pão": { c: 49, p: 9, f: 3, kcal: 265, unit: "Pão Francês", approx: { unidade: 50 } },
            "azeite": { c: 0, p: 0, f: 100, kcal: 884, unit: "Azeite de Oliva", approx: { colher: 12, fio: 5 } },
            "macarrao": { c: 30, p: 5, f: 1, kcal: 157, unit: "Macarrão (Cozido)", approx: { escumadeira: 90, pegador: 100, prato: 250 } },
            "tilapia": { c: 0, p: 26, f: 1.7, kcal: 128, unit: "Tilápia (Grelhada)", approx: { file: 120, pedaco: 100 } },
            "queijo": { c: 2, p: 25, f: 30, kcal: 400, unit: "Queijo Mussarela", approx: { fatia: 20, pedaco: 30 } }
        };

        // --- FIREBASE SETUP ---
        let firebaseConfig;
        let appId = 'default-app-id';

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } else {
             firebaseConfig = {
                apiKey: "AIzaSyBfy01I69nNCABxnYSqK95e8TwGP1bSv2w",
                authDomain: "irontracks-e6344.firebaseapp.com",
                projectId: "irontracks-e6344",
                storageBucket: "irontracks-e6344.firebasestorage.app",
                messagingSenderId: "212508580918",
                appId: "1:212508580918:web:dd55c3088fec86b8680c97"
            };
            appId = "irontracks-prod";
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userSettings = { cals: 2100, prot: 240, carb: 180, fat: 45, weight: 93, wheyDose: 30, wheyProt: 24 }; 
        let dailyLog = { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 } };
        let tempMealAnalysis = null;
        let unsubscribeSettings = null;
        let unsubscribeLogs = null;

        // --- AUTH ---
        const googleProvider = new GoogleAuthProvider();

        const handleLogin = async () => {
            try { await signInWithPopup(auth, googleProvider); } catch (error) { console.error(error); alert("Erro no login. Se estiver no preview, isso é normal."); }
        };

        const handleLogout = async () => {
            try { await signOut(auth); } catch (error) { console.error(error); }
        };

        const initAuth = async () => {
             if (typeof __firebase_config !== 'undefined' && !auth.currentUser) {
                 try {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) { console.error(error); }
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('user-status').classList.remove('hidden');
                document.getElementById('user-status').classList.add('flex');
                document.getElementById('username-display').innerText = user.displayName || "Visitante";
                loadUserSettings();
                loadDailyLog();
            } else {
                currentUser = null;
                document.getElementById('btn-login').classList.remove('hidden');
                document.getElementById('user-status').classList.add('hidden');
                document.getElementById('user-status').classList.remove('flex');
                resetUIState();
            }
        });

        initAuth();

        // --- PRESETS DR CARLOS ---
        window.applyPreset = (type) => {
            const presets = {
                'A': { cals: 2100, prot: 240, carb: 180, fat: 45 }, // Massacre
                'B': { cals: 1750, prot: 260, carb: 60, fat: 55 }  // Vacuo
            };
            
            const p = presets[type];
            document.getElementById('goal-cals').value = p.cals;
            document.getElementById('goal-prot').value = p.prot;
            document.getElementById('goal-carb').value = p.carb;
            document.getElementById('goal-fat').value = p.fat;
            
            alert(`Preset ${type === 'A' ? 'MASSACRE' : 'VÁCUO'} carregado. Clique em salvar.`);
        };

        // --- DATABASE OPS ---
        function resetUIState() {
             userSettings = { cals: 2100, prot: 240, carb: 180, fat: 45, weight: 93, wheyDose: 30, wheyProt: 24 };
             dailyLog = { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 } };
             updateUIInputs();
             updateDashboard();
             renderLogs();
             if(unsubscribeSettings) unsubscribeSettings();
             if(unsubscribeLogs) unsubscribeLogs();
        }

        async function loadUserSettings() {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'goals');
            
            unsubscribeSettings = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userSettings = { ...userSettings, ...data }; // Merge defaults
                    updateUIInputs();
                    updateDashboard();
                    document.getElementById('goals-section').classList.add('hidden');
                } else {
                    document.getElementById('goals-section').classList.remove('hidden');
                }
            }, (error) => console.log("Error loading settings", error));
        }

        async function saveUserSettings(e) {
            e.preventDefault();
            if (!currentUser) return;

            const newSettings = {
                weight: Number(document.getElementById('user-weight').value) || 93,
                wheyDose: Number(document.getElementById('whey-dose').value) || 30,
                wheyProt: Number(document.getElementById('whey-prot').value) || 24,
                cals: Number(document.getElementById('goal-cals').value),
                prot: Number(document.getElementById('goal-prot').value),
                carb: Number(document.getElementById('goal-carb').value),
                fat: Number(document.getElementById('goal-fat').value)
            };

            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'goals');
            await setDoc(docRef, newSettings);
            
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "CALIBRADO!";
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-green-600');
                document.getElementById('goals-section').classList.add('hidden');
            }, 1000);
        }

        async function loadDailyLog() {
            if (!currentUser) return;
            const todayStr = new Date().toISOString().split('T')[0];
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_logs', todayStr);

            unsubscribeLogs = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    dailyLog = docSnap.data();
                    if (!dailyLog.total) dailyLog.total = { cals: 0, prot: 0, carb: 0, fat: 0 };
                } else {
                    dailyLog = { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 } };
                }
                renderLogs();
                updateDashboard();
                analyzeContext();
            }, (error) => console.log("Error loading logs", error));
        }

        async function pushMealToDB() {
            if (!currentUser || !tempMealAnalysis) return;
            const todayStr = new Date().toISOString().split('T')[0];
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_logs', todayStr);

            const newTotal = {
                cals: dailyLog.total.cals + tempMealAnalysis.totals.kcal,
                prot: dailyLog.total.prot + tempMealAnalysis.totals.p,
                carb: dailyLog.total.carb + tempMealAnalysis.totals.c,
                fat: dailyLog.total.fat + tempMealAnalysis.totals.f
            };

            const mealEntry = {
                name: tempMealAnalysis.mealName || "Refeição",
                timestamp: new Date().toISOString(),
                foods: tempMealAnalysis.foods,
                totals: tempMealAnalysis.totals,
                isApproximate: tempMealAnalysis.isApproximate
            };

            try {
                if (dailyLog.items.length === 0) {
                    await setDoc(docRef, { items: [mealEntry], total: newTotal });
                } else {
                    await updateDoc(docRef, { items: arrayUnion(mealEntry), total: newTotal });
                }
                document.getElementById('meal-input').value = "";
                document.getElementById('modal-result').classList.add('hidden');
            } catch (err) {
                console.error("Error saving meal:", err);
                alert("Erro ao salvar.");
            }
        }
        
        async function resetDay() {
            if (!currentUser) return;
            if(!confirm("Limpar todo o histórico de hoje?")) return;
            const todayStr = new Date().toISOString().split('T')[0];
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_logs', todayStr);
            await setDoc(docRef, { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 }});
        }

        // --- NEW PARSER (DR CARLOS UNITS & WHEY CONFIG) ---

        function parseInput(text) {
            const lines = text.split('\n');
            const detectedFoods = [];
            let mealName = "Refeição";
            let totals = { p:0, c:0, f:0, kcal:0 };
            let isApproximate = false;

            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                
                if (index === 0 && !/\d/.test(line)) {
                    mealName = line;
                    return;
                }
                
                let qtd = 0;
                let foodName = "";
                let unitUsed = "g";
                let matchedItem = null;
                let multiplier = 0;
                let wasApprox = false;

                const approxRegex = /(\d+)\s*(colheres?|conchas?|bifes?|fatias?|pedacos?|latas?|scoops?|unidades?|ovos?)/i;
                const gramRegex = /(\d+)\s*(g|ml)?/i;
                
                const approxMatch = line.match(approxRegex);
                const gramMatch = line.match(gramRegex);

                if (approxMatch) {
                    qtd = parseInt(approxMatch[1]);
                    let unitRaw = approxMatch[2].toLowerCase();
                    if(unitRaw.startsWith('colher')) unitUsed = 'colher';
                    else if(unitRaw.startsWith('concha')) unitUsed = 'concha';
                    else if(unitRaw.startsWith('bife')) unitUsed = 'bife';
                    else if(unitRaw.startsWith('fatia')) unitUsed = 'fatia';
                    else if(unitRaw.startsWith('pedaco')) unitUsed = 'pedaco';
                    else if(unitRaw.startsWith('lata')) unitUsed = 'lata';
                    else if(unitRaw.startsWith('scoop')) unitUsed = 'scoop';
                    else if(unitRaw.startsWith('ovo')) unitUsed = 'unidade';
                    else unitUsed = 'unidade';

                    foodName = line.replace(approxMatch[0], "").replace(" de ", " ").trim().toLowerCase();
                    wasApprox = true;
                } else if (gramMatch) {
                    qtd = parseInt(gramMatch[1]);
                    unitUsed = 'g';
                    foodName = line.replace(gramMatch[0], "").replace(" de ", " ").trim().toLowerCase();
                } else {
                    foodName = line.toLowerCase();
                    qtd = 1; 
                }

                // DB Search
                let dbKeyMatched = "";
                for (const key in foodDatabase) {
                    if (foodName.includes(key)) {
                        if (!dbKeyMatched || key.length > dbKeyMatched.length) {
                            dbKeyMatched = key;
                            matchedItem = foodDatabase[key];
                        }
                    }
                }

                if (matchedItem) {
                    // --- WHEY PROTEIN SPECIAL LOGIC ---
                    if (dbKeyMatched.includes('whey')) {
                        // User Config
                        const customDose = userSettings.wheyDose || 30;
                        const customProt = userSettings.wheyProt || 24;
                        const pRatio = customProt / customDose;
                        
                        // Approx Calories for Whey (Usually ~4kcal/g of protein + small leftover)
                        // Or we can scale database kcal/100g. 
                        // Database whey is ~400kcal/100g (standard powder). 
                        // Let's use database values for non-protein macros scaled by weight, but OVERRIDE protein.
                        
                        let weightInGrams = 0;
                        
                        if (wasApprox) {
                            isApproximate = true;
                            // Check if unit is scoop or colher
                            if(matchedItem.approx && matchedItem.approx[unitUsed]) {
                                weightInGrams = qtd * matchedItem.approx[unitUsed];
                                unitUsed = `${unitUsed} (~${weightInGrams}g)`;
                            } else {
                                weightInGrams = qtd * 30; // default scoop assumption
                                unitUsed = "scoop/dose est. (30g)";
                            }
                        } else {
                            // Direct grams (e.g. "40g whey")
                            weightInGrams = qtd;
                        }

                        // Calculate Macros based on custom protein config
                        const p = Math.round(weightInGrams * pRatio);
                        
                        // For C and F, assume standard ratios from DB (per 100g) scaled to weight
                        const c = Math.round((matchedItem.c / 100) * weightInGrams);
                        const f = Math.round((matchedItem.f / 100) * weightInGrams);
                        // Kcal = P*4 + C*4 + F*9 approx
                        const kcal = (p * 4) + (c * 4) + (f * 9);

                        totals.p += p; totals.c += c; totals.f += f; totals.kcal += kcal;

                        detectedFoods.push({
                            name: matchedItem.unit,
                            rawName: foodName,
                            qtd: qtd,
                            unitDisplay: unitUsed,
                            macros: { p, c, f, kcal }
                        });
                    } 
                    else {
                        // --- STANDARD LOGIC ---
                        if (wasApprox) {
                            isApproximate = true;
                            if (matchedItem.approx && matchedItem.approx[unitUsed]) {
                                const gramsPerUnit = matchedItem.approx[unitUsed];
                                const totalGrams = qtd * gramsPerUnit;
                                multiplier = totalGrams / 100;
                                unitUsed = `${unitUsed} (~${gramsPerUnit}g)`;
                            } else if (matchedItem.approx && matchedItem.approx['unidade']) {
                                const gramsPerUnit = matchedItem.approx['unidade'];
                                multiplier = (qtd * gramsPerUnit) / 100;
                                unitUsed = `unidade estim. (~${gramsPerUnit}g)`;
                            } else {
                                multiplier = (qtd * 50) / 100;
                                unitUsed = "unidade (estimado)";
                            }
                        } else {
                            if (matchedItem.unit.includes("Lata") || matchedItem.unit.includes("unidade") && qtd < 10) {
                                multiplier = qtd; 
                            } else {
                                multiplier = qtd / 100;
                            }
                        }

                        const p = Math.round(matchedItem.p * multiplier);
                        const c = Math.round(matchedItem.c * multiplier);
                        const f = Math.round(matchedItem.f * multiplier);
                        const kcal = Math.round(matchedItem.kcal * multiplier);

                        totals.p += p; totals.c += c; totals.f += f; totals.kcal += kcal;

                        detectedFoods.push({
                            name: matchedItem.unit,
                            rawName: foodName,
                            qtd: qtd,
                            unitDisplay: unitUsed,
                            macros: { p, c, f, kcal }
                        });
                    }
                } else {
                     detectedFoods.push({
                        name: "Desconhecido (" + line + ")",
                        rawName: line,
                        qtd: 0,
                        unitDisplay: "?",
                        macros: { p:0, c:0, f:0, kcal:0 },
                        error: true
                    });
                }
            });

            return { mealName, foods: detectedFoods, totals, isApproximate };
        }

        function handleCalculate() {
            const text = document.getElementById('meal-input').value;
            if (!text.trim()) return;

            tempMealAnalysis = parseInput(text);
            
            const container = document.getElementById('modal-content');
            container.innerHTML = '';

            const warningEl = document.getElementById('accuracy-warning');
            if (tempMealAnalysis.isApproximate) warningEl.classList.remove('hidden');
            else warningEl.classList.add('hidden');

            const header = document.createElement('div');
            header.className = "bg-slate-900 rounded p-3 mb-4 text-center border border-slate-700";
            header.innerHTML = `
                <div class="text-xl font-bold text-white">${tempMealAnalysis.mealName}</div>
                <div class="flex justify-center gap-4 mt-2 text-sm">
                    <span class="text-purple-400 font-bold">${tempMealAnalysis.totals.kcal} kcal</span>
                    <span class="text-green-400 font-mono">P:${tempMealAnalysis.totals.p}</span>
                    <span class="text-blue-400 font-mono">C:${tempMealAnalysis.totals.c}</span>
                    <span class="text-yellow-400 font-mono">G:${tempMealAnalysis.totals.f}</span>
                </div>
            `;
            container.appendChild(header);

            tempMealAnalysis.foods.forEach(item => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center py-2 border-b border-slate-700 last:border-0";
                if (item.error) {
                    row.innerHTML = `<div class="text-red-400"><i class="fa-solid fa-triangle-exclamation mr-2"></i>${item.rawName} <span class="text-xs opacity-70">(Não encontrado)</span></div>`;
                } else {
                    row.innerHTML = `
                        <div>
                            <div class="text-gray-200 font-medium text-sm">${item.name}</div>
                            <div class="text-xs text-cyan-500">${item.qtd} ${item.unitDisplay}</div>
                        </div>
                        <div class="text-right text-xs text-gray-400 font-mono">
                            <div>${item.macros.kcal} kcal</div>
                            <div class="flex gap-1">
                                <span class="text-green-600">P:${item.macros.p}</span>
                                <span class="text-blue-600">C:${item.macros.c}</span>
                                <span class="text-yellow-600">G:${item.macros.f}</span>
                            </div>
                        </div>`;
                }
                container.appendChild(row);
            });
            document.getElementById('modal-result').classList.remove('hidden');
        }

        function updateUIInputs() {
            document.getElementById('user-weight').value = userSettings.weight;
            document.getElementById('whey-dose').value = userSettings.wheyDose;
            document.getElementById('whey-prot').value = userSettings.wheyProt;
            document.getElementById('goal-cals').value = userSettings.cals;
            document.getElementById('goal-prot').value = userSettings.prot;
            document.getElementById('goal-carb').value = userSettings.carb;
            document.getElementById('goal-fat').value = userSettings.fat;
            
            document.getElementById('target-cals').innerText = userSettings.cals;
            document.getElementById('target-prot').innerText = userSettings.prot;
            document.getElementById('target-carb').innerText = userSettings.carb;
            document.getElementById('target-fat').innerText = userSettings.fat;
        }

        function updateDashboard() {
            const t = dailyLog.total;
            const g = userSettings;
            
            document.getElementById('display-cals').innerText = t.cals;
            document.getElementById('display-prot').innerText = t.prot;
            document.getElementById('display-carb').innerText = t.carb;
            document.getElementById('display-fat').innerText = t.fat;

            const balance = g.cals - t.cals;
            document.getElementById('saldo-cals').innerText = `BUFFER: ${balance}`;
            
            setBar('bar-cals', t.cals, g.cals);
            setBar('bar-prot', t.prot, g.prot);
            setBar('bar-carb', t.carb, g.carb);
            setBar('bar-fat', t.fat, g.fat);
        }

        function setBar(id, val, max) {
            const pct = Math.min(100, Math.max(0, (val / max) * 100));
            const el = document.getElementById(id);
            if (id === 'bar-cals') el.style.width = `${pct}%`;
            else el.style.height = `${pct}%`;
            if (val > max) el.classList.add('bg-red-500'); else el.classList.remove('bg-red-500');
        }

        function renderLogs() {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            if (!dailyLog.items || dailyLog.items.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-600 py-4 italic text-sm">Nenhuma refeição hoje.</div>';
                return;
            }
            dailyLog.items.slice().reverse().forEach(log => {
                const el = document.createElement('div');
                const borderClass = log.isApproximate ? 'border-yellow-500' : 'border-cyan-500';
                const bgClass = log.isApproximate ? 'bg-yellow-900/10' : 'bg-slate-800/50';
                el.className = `${bgClass} rounded-lg p-3 border-l-2 ${borderClass} flex justify-between items-center`;
                const foodDesc = log.foods.map(f => f.name.split(' ')[0]).join(', ');
                el.innerHTML = `
                    <div><div class="text-sm font-bold text-gray-200">${log.name} ${log.isApproximate ? '<i class="fa-solid fa-triangle-exclamation text-yellow-500 text-[10px]" title="Aproximado"></i>' : ''}</div><div class="text-xs text-gray-500 truncate w-40">${foodDesc}</div></div>
                    <div class="text-right"><div class="text-sm font-bold text-white">${log.totals.kcal} kcal</div><div class="text-[10px] text-gray-400 flex gap-2 font-mono"><span class="text-green-500">P:${log.totals.p}</span><span class="text-blue-500">C:${log.totals.c}</span><span class="text-yellow-500">G:${log.totals.f}</span></div></div>`;
                container.appendChild(el);
            });
        }

        // --- DR CARLOS AI (VARIÁVEL) ---
        function analyzeContext() {
            const t = dailyLog.total;
            const g = userSettings;
            const weight = g.weight || 93;
            const minProtein = weight * 2.5; 

            const box = document.getElementById('suggestion-box');
            const txt = document.getElementById('suggestion-text');
            box.classList.remove('hidden');

            const pctKcal = t.cals / g.cals;
            
            // Phrases DB
            const phrases = {
                catabolic: [
                    "<b>ALERTA DE CATABOLISMO!</b> A proteína está baixa. O músculo não cresce com ar. Mande Whey ou Ovos agora.",
                    "Você está brincando de fazer dieta? Proteína ridícula. Corrija isso antes de dormir ou perderá massa.",
                    "Seu corpo está implorando por aminoácidos. A síntese proteica parou. Coma proteína IMEDIATAMENTE."
                ],
                overLimit: [
                    "Meta calórica estourada. Pare de comer. O GH age no sono, não na digestão pesada.",
                    "Você já passou do limite. Beba 1 litro de água e vá dormir. Amanhã o cardio será dobrado.",
                    "Chega por hoje. Seu saldo acabou. Não transforme superávit em gordura visceral."
                ],
                massacreNeedCarb: [
                    "Hoje é dia de <b>MASSACRE</b> e seu carbo está baixo. O treino vai falhar sem glicogênio. Carregue agora.",
                    "Sem carbo, sem força. É dia de perna/costas? Coma arroz ou batata já.",
                    "A insulina precisa subir pro treino render. O tanque está vazio. Encha de carbo limpo."
                ],
                onTrack: [
                    `Protocolo em andamento. Você tem <b>${g.cals - t.cals} kcal</b> de buffer. Mantenha a disciplina.`,
                    "Segue o plano. A constância é o segredo. Não erra.",
                    "Engenharia metabólica funcionando. Tudo dentro dos parâmetros. Continue focado."
                ]
            };

            const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];

            // Logic Tree
            if (t.prot < minProtein && pctKcal > 0.8) {
                txt.innerHTML = getRandom(phrases.catabolic);
                box.className = "bg-red-900/30 border-l-4 border-red-500 p-3 rounded text-sm text-red-200";
            } else if (pctKcal > 1.05) {
                txt.innerHTML = getRandom(phrases.overLimit);
                box.className = "bg-red-900/30 border-l-4 border-red-500 p-3 rounded text-sm text-red-200";
            } else if (g.carb > 150 && t.carb < 50 && pctKcal > 0.4) {
                 txt.innerHTML = getRandom(phrases.massacreNeedCarb);
                 box.className = "bg-blue-900/30 border-l-4 border-blue-500 p-3 rounded text-sm text-blue-200";
            } else {
                 txt.innerHTML = getRandom(phrases.onTrack);
                 box.className = "bg-slate-800/50 border-l-4 border-cyan-500 p-3 rounded text-sm text-gray-300";
            }
        }

        // --- EVENT LISTENERS ---
        document.getElementById('goals-form').addEventListener('submit', saveUserSettings);
        document.getElementById('edit-goals-btn').addEventListener('click', () => document.getElementById('goals-section').classList.remove('hidden'));
        document.getElementById('close-goals-btn').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('goals-section').classList.add('hidden'); });
        document.getElementById('btn-calculate').addEventListener('click', handleCalculate);
        document.getElementById('close-modal').addEventListener('click', () => document.getElementById('modal-result').classList.add('hidden'));
        document.getElementById('confirm-meal').addEventListener('click', pushMealToDB);
        document.getElementById('reset-day-btn').addEventListener('click', resetDay);
        document.getElementById('btn-login').addEventListener('click', handleLogin);
        document.getElementById('btn-logout').addEventListener('click', handleLogout);

    </script>
</body>
</html>
